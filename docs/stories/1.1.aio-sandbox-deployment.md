# Story 1.1: AIO Sandbox并行部署与基础集成

## Status
In Progress

## Story
**As a** 最终用户,
**I want** 系统能够同时支持新旧两个Sandbox环境的并行部署和基础集成,
**so that** 我可以在保持现有功能不变的基础上，获得更强大的AIO Sandbox增强能力。

## Acceptance Criteria
1. AIO Sandbox成功部署在独立的Docker容器中，运行在8081端口
2. 现有自建Sandbox保持完全不变，继续运行在8080端口
3. Backend能够识别并路由请求到两个不同的Sandbox环境
4. 建立基础API通信测试，验证Backend与两个Sandbox的连接正常
5. 实现双Sandbox运行状态监控机制
6. MCP (Model Context Protocol) 标准工具接口基础集成验证
7. 两个Sandbox环境可以同时稳定运行，无端口冲突

## Tasks / Subtasks
- [ ] 部署AIO Sandbox容器 (AC: #1)
  - [ ] 研究AIO Sandbox官方部署文档
  - [ ] 创建AIO Sandbox Docker配置文件
  - [ ] 配置容器网络和端口映射(8081)
  - [ ] 验证AIO Sandbox容器正常启动
- [ ] 配置Backend路由适配 (AC: #2, #3)
  - [ ] 分析现有Sandbox API调用模式
  - [ ] 创建Sandbox环境选择器组件
  - [ ] 实现Backend路由层双Sandbox支持
  - [ ] 确保现有API完全兼容旧Sandbox
- [ ] 建立基础通信测试 (AC: #4, #6)
  - [ ] 创建双Sandbox健康检查端点
  - [ ] 实现MCP协议基础集成测试
  - [ ] 验证文件操作API在两个环境中正常工作
  - [ ] 验证Shell命令执行API在两个环境中正常工作
- [ ] 创建监控机制 (AC: #5, #7)
  - [ ] 实现Sandbox容器状态监控
  - [ ] 创建端口可用性检查
  - [ ] 建立异常情况告警机制
  - [ ] 验证双环境并行稳定性

## Dev Notes
### 相关源树信息
**Backend相关路径:**
- `backend/app/interfaces/api/routes/sandbox.py` - Sandbox路由定义
- `backend/app/domain/services/sandbox_service.py` - Sandbox业务逻辑
- `backend/app/infrastructure/external/sandbox_client.py` - Sandbox客户端

**Docker配置路径:**
- `docker-compose.yml` - 主容器编排
- `sandbox/Dockerfile` - 现有Sandbox容器定义

**现有模式参考:**
- Backend采用DDD分层架构，遵循依赖倒置原则
- 使用FastAPI进行RESTful API设计
- 容器间通过内部Docker网络通信
- 现有Sandbox使用Supervisor进行多进程管理

### 技术集成要点
**MCP协议集成:**
- 参考官方文档: https://modelcontextprotocol.io/
- 使用标准工具接口格式
- 确保与现有工具系统集成兼容性

**网络配置:**
- 旧Sandbox: 8080端口 (保持不变)
- 新AIO Sandbox: 8081端口
- Backend通过内部网络访问两个Sandbox

**兼容性要求:**
- 现有API签名完全保持不变
- 前端默认使用旧Sandbox，新功能为可选
- 数据库结构无变更需求

### Testing
**测试标准:**
- 测试文件位置: `backend/tests/test_sandbox_integration.py`
- 使用pytest框架进行单元测试和集成测试
- 遵循AAA模式 (Arrange, Act, Assert)
- 测试覆盖率要求: 90%以上

**测试重点:**
- 双Sandbox并行运行稳定性测试
- API路由正确性验证
- MCP协议集成功能测试
- 端口冲突解决验证
- 现有功能回归测试

**性能测试:**
- 双环境并行资源使用监控
- API响应时间对比测试
- 容器启动时间基准测试

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | 初始故事创建 | Sarah |

## Dev Agent Record
### Agent Model Used
*待开发代理填写*

### Debug Log References
*待开发代理填写*

### Completion Notes List
*待开发代理填写*

### File List
*待开发代理填写*

## QA Results
*待QA代理填写*