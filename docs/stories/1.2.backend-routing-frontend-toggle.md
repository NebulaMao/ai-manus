# Story 1.2: Backend路由层与前端开关开发

## Status
Draft

## Story
**As a** 最终用户,
**I want** 通过前端开关自由选择Sandbox环境，系统能智能路由我的请求到对应环境,
**so that** 我可以根据任务需求灵活使用最适合的Sandbox环境，获得最佳的使用体验。

## Acceptance Criteria
1. 前端提供直观的Sandbox环境选择开关组件，支持实时切换
2. Backend实现动态路由选择逻辑，能根据用户选择智能分发API请求
3. 用户Sandbox选择偏好能够持久化存储，登录后自动恢复
4. 前后端实现实时状态同步，确保选择状态一致性
5. 切换过程对用户透明，无需重新登录或刷新页面
6. 提供清晰的环境状态指示，用户明确知道当前使用的Sandbox
7. 异常情况下自动回退机制，确保服务连续性
8. 现有功能100%兼容，默认使用旧Sandbox环境

## Tasks / Subtasks
- [ ] 前端Sandbox选择器UI组件开发 (AC: #1, #6)
  - [ ] 设计Sandbox选择器UI/UX界面
  - [ ] 实现Vue 3 + TypeScript选择器组件
  - [ ] 添加环境状态指示和动画效果
  - [ ] 集成到现有前端布局中
  - [ ] 响应式设计适配不同屏幕尺寸
- [ ] Backend路由服务重构 (AC: #2, #8)
  - [ ] 分析现有Sandbox API调用模式和数据流
  - [ ] 创建Sandbox路由选择服务类
  - [ ] 重构现有API控制器以支持动态路由
  - [ ] 实现负载均衡和健康检查集成
  - [ ] 确保向后兼容性和默认行为
- [ ] 用户偏好存储系统 (AC: #3, #7)
  - [ ] 设计用户偏好数据模型
  - [ ] 实现偏好存储API端点
  - [ ] 集成到现有用户认证系统
  - [ ] 添加偏好设置管理和重置功能
  - [ ] 实现偏好迁移和版本兼容
- [ ] 实时状态同步API (AC: #4, #5)
  - [ ] 设计前后端状态同步协议
  - [ ] 实现WebSocket或SSE状态推送
  - [ ] 添加状态变更事件处理机制
  - [ ] 实现断线重连和状态恢复
  - [ ] 优化同步性能和可靠性
- [ ] 异常处理和回退机制 (AC: #7, #8)
  - [ ] 实现Sandbox可用性检测机制
  - [ ] 创建自动回退逻辑和策略
  - [ ] 添加错误处理和用户通知
  - [ ] 实现服务降级和优雅切换
  - [ ] 建立监控和告警机制

## Dev Notes
### 相关源树信息
**前端相关路径:**
- `frontend/src/components/SandboxSelector.vue` - 新建选择器组件
- `frontend/src/stores/sandbox.ts` - Sandbox状态管理
- `frontend/src/api/sandbox.ts` - Sandbox API调用
- `frontend/src/layouts/DefaultLayout.vue` - 布局集成点

**Backend相关路径:**
- `backend/app/domain/services/sandbox_router.py` - 新建路由服务
- `backend/app/interfaces/api/routes/sandbox.py` - 路由控制器
- `backend/app/infrastructure/repositories/user_preference.py` - 用户偏好存储
- `backend/app/domain/models/sandbox_config.py` - Sandbox配置模型

**现有模式参考:**
- 前端使用Vue 3 Composition API + TypeScript
- 状态管理采用Pinia (如果存在) 或Composition API
- Backend遵循DDD分层架构模式
- 使用FastAPI的依赖注入系统

### 技术集成要点
**前端选择器设计:**
- 采用Toggle Switch设计模式
- 支持键盘无障碍访问
- 集成Tailwind CSS样式系统
- 添加加载状态和错误状态显示

**Backend路由策略:**
- 使用策略模式实现不同Sandbox的路由逻辑
- 集成现有健康检查机制
- 实现熔断器模式防止级联故障
- 支持A/B测试和灰度发布

**状态同步机制:**
- 使用Server-Sent Events (SSE) 实现单向状态推送
- 集成现有的WebSocket连接池（如果存在）
- 实现状态版本控制和冲突解决
- 添加状态缓存和本地存储

### 安全考虑
**用户隐私:**
- 用户偏好数据加密存储
- 敏感配置信息不暴露给前端
- 实现细粒度的权限控制

**系统安全:**
- 路由选择逻辑防止恶意切换
- 实现请求频率限制
- 添加审计日志记录

### Testing
**测试标准:**
- 前端测试: `frontend/tests/components/SandboxSelector.spec.ts`
- 后端测试: `backend/tests/test_sandbox_router.py`
- 集成测试: `backend/tests/test_sandbox_integration.py`
- E2E测试: `e2e/tests/sandbox-switching.spec.ts`

**测试重点:**
- UI组件交互测试（点击、键盘导航）
- 路由选择逻辑正确性验证
- 状态同步可靠性和性能测试
- 异常场景和边界条件测试
- 跨浏览器兼容性测试

**性能测试:**
- 切换响应时间 < 100ms
- 状态同步延迟 < 50ms
- 并发用户切换压力测试
- 内存泄漏和资源使用监控

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-05 | 1.0 | 初始故事创建 | Sarah |

## Dev Agent Record
### Agent Model Used
*待开发代理填写*

### Debug Log References
*待开发代理填写*

### Completion Notes List
*待开发代理填写*

### File List
*待开发代理填写*

## QA Results
*待QA代理填写*