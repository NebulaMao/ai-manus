# AIO Sandbox Migration - Brownfield Enhancement

> **史诗ID**: EPIC-001
> **创建日期**: 2025-11-05
> **产品经理**: Sarah
> **项目**: AI Manus Sandbox 技术升级
> **类型**: 棕地增强 (Brownfield Enhancement)
> **预估工期**: 4-5周

---

## 🎯 史诗目标

在保留现有自建Sandbox的基础上，集成AIO Sandbox作为增强选项，通过前端开关让用户自由选择使用哪个Sandbox环境，实现零风险的功能增强和用户体验提升。

---

## 📋 史诗描述

### 现有系统上下文

**当前相关功能：**
- 自建FastAPI Sandbox服务，运行在独立容器
- 支持文件系统操作 (app/api/v1/file.py)
- 支持Shell命令执行 (app/api/v1/shell.py)
- 支持进程管理 (app/api/v1/supervisor.py)
- 支持VNC远程桌面 (5900端口)
- 支持Playwright浏览器自动化

**技术栈：**
- FastAPI + Uvicorn
- Docker + Supervisor多进程管理
- x11vnc + websockify (VNC服务)
- Playwright (浏览器自动化)

**集成点：**
- Backend通过RESTful API调用Sandbox服务 (端口8080)
- Frontend通过VNC客户端访问远程桌面
- 现有API端点设计遵循RESTful规范

### 增强详情

**新增/变更内容：**
- 保留现有自建Sandbox完全不变
- 新增AIO Sandbox作为并行增强选项
- 采用MCP (Model Context Protocol) 标准工具接口
- 集成CDP (Chrome DevTools Protocol) 浏览器控制
- 获得内置Jupyter、VSCode Server开发环境
- 新增前端开关组件，用户可自由选择Sandbox环境

**集成方式：**
- 两个Sandbox并行运行 (旧Sandbox: 8080端口, AIO Sandbox: 8081端口)
- 通过Backend路由层动态选择Sandbox服务
- 前端增加Sandbox选择开关，用户可实时切换
- 保持现有API完全兼容，用户无感知迁移

**成功标准：**
- 4-5周内完成双Sandbox集成
- 100%现有功能保持 (包括VNC)
- 用户可自由选择新旧Sandbox环境
- 前端开关功能完善，切换流畅
- 显著增强开发能力和生态集成

---

## 📝 故事列表

### Story 1: AIO Sandbox并行部署与基础集成
**预估**: 1周
**重点**: 验证AIO Sandbox部署可行性，建立与现有Sandbox并行的双环境

### Story 2: Backend路由层与前端开关开发
**预估**: 2-3周
**重点**: 开发Backend路由选择逻辑和前端Sandbox切换开关组件

### Story 3: 双Sandbox功能验证与优化
**预估**: 1周
**重点**: 验证双环境切换功能，性能优化，用户体验完善

---

## ✅ 兼容性要求

- [x] **现有Sandbox完全保留** - 旧Sandbox保持原样，无任何修改
- [x] **现有API保持不变** - 所有现有API端点和签名完全不变
- [x] **数据库架构变更向后兼容** - 本次集成无数据库变更
- [x] **前端界面向后兼容** - 默认使用旧Sandbox，新功能为可选增强
- [x] **性能影响最小** - 并行运行不影响现有系统性能

---

## ⚠️ 风险缓解

### 主要风险
**前端开关组件和Backend路由层的复杂性可能影响用户体验**

### 缓解措施
- **零风险策略**: 旧Sandbox完全保留，新功能为可选增强
- **渐进式开发**: 先实现基础切换，再优化用户体验
- **充分测试**: 建立双环境切换的完整测试套件
- **技术预研**: 提前验证MCP协议和CDP接口集成

### 回滚计划
- 旧Sandbox始终保持独立运行
- 新功能出现问题可立即禁用开关
- 监控告警机制，异常时自动回退到旧Sandbox
- 用户可手动选择使用旧Sandbox

---

## 🎯 完成定义 (Definition of Done)

- [ ] **所有故事完成** - 3个故事全部完成并满足验收标准
- [ ] **现有功能验证** - 旧Sandbox功能100%保持，无任何影响
- [ ] **双环境集成** - 新旧Sandbox并行稳定运行
- [ ] **前端开关功能** - 用户可流畅切换Sandbox环境
- [ ] **文档更新** - 架构文档、用户指南、开发文档更新
- [ ] **用户体验优化** - 切换过程无感知，功能对比清晰

---

## 🔗 相关文档

- **架构研究报告**: `docs/ai-manus-sandbox-to-aio-sandbox-migration-report.md`
- **技术参考**: https://github.com/agent-infra/sandbox
- **MCP协议**: https://modelcontextprotocol.io/
- **CDP协议**: https://chromedevtools.github.io/devtools-protocol/

---

## 📊 验证检查清单

### 范围验证 ✅
- [x] 史诗可在3个故事内完成
- [x] 不需要额外架构文档 (已有详细研究报告)
- [x] 增强遵循现有模式 (API兼容性优先)
- [x] 集成复杂度可管理 (适配层模式成熟)

### 风险评估 ✅
- [x] 现有系统风险低 (蓝绿部署策略)
- [x] 回滚计划可行 (容器级快速切换)
- [x] 测试覆盖完整 (回归测试 + 性能测试)
- [x] 团队具备知识 (MCP协议学习成本可控)

### 完整性检查 ✅
- [x] 史诗目标清晰且可达成
- [x] 故事范围适当且可执行
- [x] 成功标准具体可衡量
- [x] 依赖关系明确识别

---

## 🤝 Story Manager 移交信息

**移交说明:**

"请为这个棕地史诗制定详细的用户故事和验收标准。关键考虑因素：

- **系统环境**: 现有 Vue 3 + TypeScript + FastAPI + Python + Docker 系统
- **集成策略**: 双Sandbox并行运行，Backend路由层动态选择，前端开关用户控制
- **遵循模式**: 微服务架构、DDD分层、现有功能完全保留
- **关键要求**: 旧Sandbox完全不变、新功能可选增强、用户自由选择、前端切换流畅
- **质量保证**: 每个故事必须包含双环境功能验证和切换体验测试

该史诗应在完全保持现有系统稳定性的前提下，交付用户可选的AIO Sandbox增强能力和流畅的切换体验。"

---

## 📈 业务价值

### 技术收益
- **双环境选择**: 用户可根据需求选择最适合的Sandbox环境
- **标准化**: 采用行业标准的MCP和CDP协议
- **生态集成**: 接入丰富的AI Agent生态系统
- **开发效率**: 内置Jupyter和VSCode开发环境
- **渐进式升级**: 用户可按自己的节奏适应新环境

### 风险控制
- **零风险**: 旧Sandbox完全保留，新功能为可选增强
- **功能保持**: 100%现有功能兼容，无任何影响
- **用户控制**: 用户始终可选择使用熟悉的旧环境
- **渐进验证**: 双环境并行降低实施风险

### 用户体验提升
- **选择自由**: 用户可根据任务需求选择最佳环境
- **平滑过渡**: 用户可在使用中逐步适应新功能
- **功能对比**: 清晰展示新旧环境的功能差异
- **无强制升级**: 尊重用户使用习惯，不强制改变

---

*史诗创建完成，等待Story Manager制定详细用户故事*

*最后更新时间: 2025-11-05*